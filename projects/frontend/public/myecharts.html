<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>传感器监控中心</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #0a1630;
            color: #fff;
            font-family: 'Orbitron', sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .dashboard-container {
            height: 100vh;
            padding: 20px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .dashboard-header .title {
            font-size: 24px;
            letter-spacing: 2px;
            margin: 0;
        }

        .dashboard-header .subtitle {
            font-size: 14px;
            color: #7d8ea3;
            margin-left: 15px;
        }

        .time-panel {
            text-align: right;
        }

        .system-time {
            font-size: 18px;
            color: #00ff88;
        }

        .update-time {
            font-size: 12px;
            color: #7d8ea3;
        }

        .dashboard-main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 140px);
        }

        .realtime-panel, .history-panel {
            display: flex;
            flex-direction: column;
        }

        .status-cards {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-header i {
            font-size: 24px;
            margin-right: 10px;
        }

        .card-body .value {
            font-size: 36px;
            font-family: 'Orbitron', sans-serif;
            color: #00ff88;
        }

        .card-body .unit {
            color: #7d8ea3;
            margin: 5px 0;
        }

        .card-body .trend {
            color: #7d8ea3;
            font-size: 12px;
        }

        .card-body .trend i {
            margin-right: 5px;
        }

        .temperature {
            border-left: 4px solid #ff4757;
        }

        .humidity {
            border-left: 4px solid #2ed573;
        }

        .distance {
            border-left: 4px solid #3742fa;
        }

        .chart {
            height: 400px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            flex-grow: 1;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .history-header h2 {
            margin: 0;
        }

        .data-table {
            margin-top: 20px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            height: 300px;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            color: #fff;
        }

        th {
            background: rgba(255,255,255,0.05) !important;
            color: #00ff88 !important;
            padding: 10px;
            text-align: left;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05) !important;
        }

        tr:hover td {
            background: rgba(255,255,255,0.02) !important;
        }

        /* 日期选择器样式 */
        .date-picker {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- 数据看板头部 -->
        <div class="dashboard-header">
            <h1 class="title">
                <i class="fas fa-satellite-dish"></i>
                传感器监控中心
                <span class="subtitle">Sensor Monitoring Center</span>
            </h1>
            <div class="time-panel">
                <div class="system-time" id="currentTime"></div>
                <div class="update-time" id="updateTime">
                    最后更新: --
                </div>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="dashboard-main">
            <!-- 左区：实时数据 -->
            <div class="realtime-panel">
                <div class="status-cards">
                    <!-- 温度卡片 -->
                    <div class="metric-card temperature">
                        <div class="card-header">
                            <i class="fas fa-thermometer-half"></i>
                            <h3>实时温度</h3>
                        </div>
                        <div class="card-body">
                            <div class="value" id="temperatureValue">--</div>
                            <div class="unit">℃</div>
                            <div class="trend">
                                <i class="fas fa-chart-line"></i>
                                <span>24h趋势</span>
                            </div>
                        </div>
                    </div>

                    <!-- 湿度卡片 -->
                    <div class="metric-card humidity">
                        <div class="card-header">
                            <i class="fas fa-tint"></i>
                            <h3>环境湿度</h3>
                        </div>
                        <div class="card-body">
                            <div class="value" id="humidityValue">--</div>
                            <div class="unit">%</div>
                            <div class="trend">
                                <i class="fas fa-chart-area"></i>
                                <span>历史波动</span>
                            </div>
                        </div>
                    </div>

                    <!-- 距离卡片 -->
                    <div class="metric-card distance">
                        <div class="card-header">
                            <i class="fas fa-ruler-combined"></i>
                            <h3>超声测距</h3>
                        </div>
                        <div class="card-body">
                            <div class="value" id="distanceValue">--</div>
                            <div class="unit">cm</div>
                            <div class="trend">
                                <i class="fas fa-wave-square"></i>
                                <span>动态范围</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 实时数据图表 -->
                <div class="realtime-chart">
                    <div id="realtimeChart" class="chart"></div>
                </div>
            </div>

            <!-- 右区：历史数据 -->
            <div class="history-panel">
                <div class="history-header">
                    <h2><i class="fas fa-history"></i> 历史趋势分析</h2>
                    <input type="date" id="historyDate" class="date-picker" value="">
                </div>
                <div id="historyChart" class="chart"></div>
                <div class="data-table">
                    <table id="historyTable">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>温度(℃)</th>
                                <th>湿度(%)</th>
                                <th>距离(cm)</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- 数据将通过JS动态填充 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let realtimeChart = null;
        let historyChart = null;
        let pollingInterval = null;
        let timeInterval = null;
        let realtimeData = {
            temperature: null,
            humidity: null,
            ultrasonic: null,
            updateTime: null
        };
        let historyData = [];

        // 初始化函数
        function init() {
            initCharts();
            startPolling();
            updateSystemTime();
            
            // 设置默认日期为今天
            document.getElementById('historyDate').value = moment().format('YYYY-MM-DD');
            document.getElementById('historyDate').addEventListener('change', fetchHistoryData);
            
            // 窗口大小变化时重绘图表
            window.addEventListener('resize', handleResize);
        }

        // 初始化图表
        function initCharts() {
            realtimeChart = echarts.init(document.getElementById('realtimeChart'));
            historyChart = echarts.init(document.getElementById('historyChart'));
            
            const commonOption = {
                grid: { top: 40, right: 30, bottom: 30, left: 50 },
                tooltip: { trigger: 'axis' }
            };

            // 实时图表配置
            realtimeChart.setOption({
                ...commonOption,
                title: { text: '实时数据流', left: 'center' },
                xAxis: { type: 'category', data: [] },
                yAxis: { type: 'value' },
                series: [{
                    name: '传感器值',
                    type: 'line',
                    smooth: true,
                    itemStyle: { color: '#36a3f7' },
                    areaStyle: { color: 'rgba(54, 163, 247, 0.1)' }
                }]
            });

            // 历史图表配置
            historyChart.setOption({
                ...commonOption,
                title: { text: '  ', left: 'center' },
                xAxis: { type: 'category', data: [] },
                yAxis: { type: 'value' },
                legend: {
                    data: ['温度', '湿度', '距离']
                },
                series: [
                    { name: '温度', type: 'line', smooth: true, showSymbol: false, itemStyle: { color: '#ff4757' } },
                    { name: '湿度', type: 'line', smooth: true, showSymbol: false, itemStyle: { color: '#2ed573' } },
                    { name: '距离', type: 'line', smooth: true, showSymbol: false, itemStyle: { color: '#3742fa' } }
                ]
            });
        }

        // 获取实时数据
        // 获取实时数据
        async function fetchRealtimeData() {
            try {
                // 使用真实API调用
                const response = await axios.get('http://localhost:8081/api/sensor/realtime');
                
                // 根据您提供的API响应结构，直接使用返回的数据
                realtimeData = {
                    temperature: response.data.temperature,
                    humidity: response.data.humidity,
                    ultrasonic: response.data.ultrasonic,
                    updateTime: response.data.updateTime
                };

                updateUIWithRealtimeData();
                updateRealtimeChart();
            } catch (error) {
                console.error('实时数据获取失败:', error);
                
                
            }
        }

        // 获取历史数据
        async function fetchHistoryData() {
            const selectedDate = document.getElementById('historyDate').value;
            try {
                // 这里应该是你的API调用，我们使用模拟数据
                // const response = await axios.get(`/api/history-data?date=${selectedDate}`);
                // historyData = response.data || [];
                
                // 模拟数据
                historyData = generateMockHistoryData(selectedDate);

                updateUIWithHistoryData();
                updateHistoryChart();
            } catch (error) {
                console.error('历史数据获取失败:', error);
                historyData = [];
                updateUIWithHistoryData();
                updateHistoryChart();
            }
        }

        // 生成模拟历史数据
        function generateMockHistoryData(date) {
            const data = [];
            for (let i = 0; i < 24; i++) {
                data.push({
                    time: moment(date).add(i, 'hours').toISOString(),
                    temperature: (20 + Math.random() * 20).toFixed(1),
                    humidity: (30 + Math.random() * 50).toFixed(1),
                    distance: (50 + Math.random() * 150).toFixed(1)
                });
            }
            return data;
        }

        // 更新UI实时数据
        function updateUIWithRealtimeData() {
            document.getElementById('temperatureValue').textContent = realtimeData.temperature ?? '--';
            document.getElementById('humidityValue').textContent = realtimeData.humidity ?? '--';
            document.getElementById('distanceValue').textContent = realtimeData.ultrasonic ?? '--';
            document.getElementById('updateTime').textContent = `最后更新: ${formatTime(realtimeData.updateTime) || '--'}`;
        }

        // 更新UI历史数据
        function updateUIWithHistoryData() {
            const tableBody = document.getElementById('historyTableBody');
            tableBody.innerHTML = '';
            
            historyData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatTime(item.time, 'HH:mm')}</td>
                    <td>${item.temperature ?? '--'}</td>
                    <td>${item.humidity ?? '--'}</td>
                    <td>${item.distance ?? '--'}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // 更新实时图表
        function updateRealtimeChart() {
            const option = {
                xAxis: { 
                    data: [...historyData.map(d => formatTime(d.time, 'HH:mm')), formatTime(realtimeData.updateTime, 'HH:mm:ss')] 
                },
                series: [{
                    data: [...historyData.map(d => d.temperature), realtimeData.temperature]
                }]
            };
            realtimeChart.setOption(option);
        }

        // 更新历史图表
        function updateHistoryChart() {
            const option = {
                xAxis: { 
                    data: historyData.map(d => formatTime(d.time, 'HH:mm')) 
                },
                series: [
                    { 
                        name: '温度',
                        data: historyData.map(d => d.temperature)
                    },
                    { 
                        name: '湿度',
                        data: historyData.map(d => d.humidity)
                    },
                    { 
                        name: '距离',
                        data: historyData.map(d => d.distance)
                    }
                ]
            };
            historyChart.setOption(option);
        }

        // 启动轮询
        function startPolling() {
            fetchRealtimeData(); // 立即获取一次数据
            pollingInterval = setInterval(() => {
                fetchRealtimeData();
            }, 2000); // 每2秒轮询一次
            
            // 初始加载历史数据
            fetchHistoryData();
        }

        // 更新时间
        function updateSystemTime() {
            document.getElementById('currentTime').textContent = moment().format('YYYY-MM-DD HH:mm:ss');
            timeInterval = setInterval(() => {
                document.getElementById('currentTime').textContent = moment().format('YYYY-MM-DD HH:mm:ss');
            }, 1000);
        }

        // 格式化时间
        function formatTime(time, format = 'YYYY-MM-DD HH:mm:ss') {
            if (!time) return '--';
            return moment(time).format(format);
        }

        // 响应窗口大小变化
        function handleResize() {
            realtimeChart?.resize();
            historyChart?.resize();
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>